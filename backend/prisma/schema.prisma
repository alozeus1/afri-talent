// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────── Existing Enums ────────────────

enum Role {
  ADMIN
  CANDIDATE
  EMPLOYER
}

enum JobStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  SHORTLISTED
  REJECTED
  ACCEPTED
}

enum ReviewStatus {
  PENDING
  REVIEWED
  APPROVED
  REJECTED
}

enum ReviewTargetType {
  JOB
  APPLICATION
  RESOURCE
}

// ──────────────── Phase A New Enums ────────────────

enum VisaSponsorshipStatus {
  YES
  NO
  UNKNOWN
}

enum JobSource {
  EMPLOYER_POSTED
  AGGREGATED
}

enum CompanyVerificationStatus {
  VERIFIED
  UNVERIFIED
  PENDING
}

enum NotificationType {
  NEW_MESSAGE
  APPLICATION_STATUS
  JOB_MATCH
  VERIFICATION
}

enum NotificationStatus {
  UNREAD
  READ
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PROFESSIONAL
}

// ──────────────── Existing Models ────────────────

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employer           Employer?
  applications       Application[]
  adminReviews       AdminReview[]       @relation("AdminReviewer")
  candidateProfile   CandidateProfile?
  subscription       Subscription?
  notifications      Notification[]
  threadParticipants ThreadParticipant[]
  sentMessages       Message[]           @relation("MessageSender")
  aiRuns             AiRun[]
  savedSearches      SavedSearch[]
  jobAlerts          JobAlert[]
  companyReviews     CompanyReview[]
  skillAssessments   SkillAssessment[]
  assessmentInvites  AssessmentInvite[]

  @@index([role])
  @@index([createdAt])
}

model Employer {
  id          String   @id @default(uuid())
  companyName String
  website     String?
  location    String
  bio         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  jobs Job[]
}

model Job {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  description String
  location    String
  type        String
  seniority   String
  salaryMin   Int?
  salaryMax   Int?
  currency    String?
  tags        String[]
  status      JobStatus
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Phase A — AfriTalent differentiators
  visaSponsorship      VisaSponsorshipStatus @default(UNKNOWN)
  relocationAssistance Boolean               @default(false)
  eligibleCountries    String[]
  jobSource            JobSource             @default(EMPLOYER_POSTED)
  sourceUrl            String?
  sourceId             String?               // external ATS/job board ID (for dedup)
  sourceName           String?               // company name for aggregated jobs

  // Nullable for aggregated jobs (no Employer profile in DB)
  employerId String?
  employer   Employer? @relation(fields: [employerId], references: [id])

  applications      Application[]
  adminReviews      AdminReview[]       @relation("JobReviews")
  threads           MessageThread[]
  jobAlerts         JobAlert[]
  assessmentInvites AssessmentInvite[]

  @@index([status])
  @@index([status, publishedAt(sort: Desc)])
  @@index([employerId])
  @@index([location])
  @@index([type])
  @@index([seniority])
  @@index([visaSponsorship])
  @@index([jobSource])
  @@index([sourceId])
}

model Application {
  id          String            @id @default(uuid())
  status      ApplicationStatus
  cvUrl       String?
  coverLetter String?
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  jobId       String
  job         Job               @relation(fields: [jobId], references: [id])

  candidateId String
  candidate   User              @relation(fields: [candidateId], references: [id])

  adminReviews AdminReview[]  @relation("ApplicationReviews")
  thread       MessageThread?

  @@unique([jobId, candidateId])
  @@index([jobId])
  @@index([candidateId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model Resource {
  id          String    @id @default(uuid())
  title       String
  slug        String    @unique
  excerpt     String
  content     String
  category    String
  coverImage  String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  adminReviews AdminReview[] @relation("ResourceReviews")

  @@index([published])
  @@index([published, publishedAt(sort: Desc)])
  @@index([category])
}

model AdminReview {
  id        String           @id @default(uuid())
  status    ReviewStatus
  notes     String?
  createdAt DateTime         @default(now())

  reviewerId String
  reviewer   User @relation("AdminReviewer", fields: [reviewerId], references: [id])

  targetType ReviewTargetType

  targetJobId         String?
  targetJob           Job?         @relation("JobReviews", fields: [targetJobId], references: [id])

  targetApplicationId String?
  targetApplication   Application? @relation("ApplicationReviews", fields: [targetApplicationId], references: [id])

  targetResourceId    String?
  targetResource      Resource?    @relation("ResourceReviews", fields: [targetResourceId], references: [id])

  @@index([reviewerId])
  @@index([targetType])
  @@index([createdAt(sort: Desc)])
}

// ──────────────── Phase A New Models ────────────────

model CandidateProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  headline        String?  @db.VarChar(200)
  bio             String?  @db.Text
  skills          String[]
  targetRoles     String[]
  targetCountries String[]
  yearsExperience Int?
  visaStatus      String?  @db.VarChar(100)
  linkedinUrl     String?  @db.VarChar(500)
  githubUrl       String?  @db.VarChar(500)
  portfolioUrl    String?  @db.VarChar(500)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  resumes Resume[]

  @@index([userId])
}

model Resume {
  id         String           @id @default(uuid())
  profileId  String
  profile    CandidateProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  s3Key      String           @db.VarChar(500)
  fileName   String           @db.VarChar(255)
  isActive   Boolean          @default(false)
  uploadedAt DateTime         @default(now())

  @@index([profileId])
  @@index([profileId, isActive])
}

model Company {
  id                    String                    @id @default(uuid())
  name                  String                    @db.VarChar(200)
  domain                String?                   @db.VarChar(255)
  logo                  String?                   @db.VarChar(500)
  description           String?                   @db.Text
  industry              String?                   @db.VarChar(100)
  size                  String?                   @db.VarChar(50) // 1-10, 11-50, 51-200, 201-500, 500+
  headquarters          String?                   @db.VarChar(200)
  founded               Int?
  website               String?                   @db.VarChar(500)
  linkedinUrl           String?                   @db.VarChar(500)
  verificationStatus    CompanyVerificationStatus @default(UNVERIFIED)
  sponsorshipTrustScore Float?
  hiresFromAfrica       Boolean                   @default(false)
  remotePolicy          String?                   @db.VarChar(50) // fully-remote, hybrid, office
  verifiedAt            DateTime?
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  reviews         CompanyReview[]
  ratingAggregate CompanyRatingAggregate?

  @@index([domain])
  @@index([verificationStatus])
  @@index([hiresFromAfrica])
}

model MessageThread {
  id            String       @id @default(uuid())
  jobId         String?
  job           Job?         @relation(fields: [jobId], references: [id])
  applicationId String?      @unique
  application   Application? @relation(fields: [applicationId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  participants ThreadParticipant[]
  messages     Message[]

  @@index([jobId])
}

model ThreadParticipant {
  id       String        @id @default(uuid())
  threadId String
  thread   MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userId   String
  user     User          @relation(fields: [userId], references: [id])
  joinedAt DateTime      @default(now())

  @@unique([threadId, userId])
  @@index([userId])
}

model Message {
  id        String        @id @default(uuid())
  threadId  String
  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderId  String
  sender    User          @relation("MessageSender", fields: [senderId], references: [id])
  body      String        @db.Text
  createdAt DateTime      @default(now())

  @@index([threadId, createdAt])
  @@index([senderId])
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  title     String             @db.VarChar(255)
  body      String             @db.VarChar(1000)
  metadata  Json?
  createdAt DateTime           @default(now())

  @@index([userId, status])
  @@index([userId, createdAt(sort: Desc)])
}

model Subscription {
  id               String             @id @default(uuid())
  userId           String             @unique
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             SubscriptionPlan   @default(FREE)
  status           SubscriptionStatus @default(INACTIVE)
  stripeCustomerId String?            @db.VarChar(255)
  stripeSubId      String?            @db.VarChar(255)
  currentPeriodEnd DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubId])
}

// ──────────────── AI Run Persistence ────────────────

enum AiRunStatus {
  RUNNING
  COMPLETE
  PARTIAL
  BLOCKED
}

enum AiRunType {
  RESUME_REVIEW
  JOB_MATCH
  APPLY_PACK
}

model AiRun {
  id               String      @id @default(uuid())
  runId            String      @unique
  userId           String
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  runType          AiRunType
  status           AiRunStatus @default(RUNNING)
  resumeHash       String?
  tokenBudgetTotal Int
  tokenBudgetUsed  Int         @default(0)
  agentCalls       Json?
  notes            String[]
  createdAt        DateTime    @default(now())
  completedAt      DateTime?

  jobs AiRunJob[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([runId])
}

model AiRunJob {
  id                String   @id @default(uuid())
  aiRunId           String
  aiRun             AiRun    @relation(fields: [aiRunId], references: [id], onDelete: Cascade)
  jobIndex          Int
  jobDbId           String?
  jobHash           String?
  jobTitle          String?
  jobCompany        String?
  jobUrl            String?
  score             Int?
  mustHavePct       Float?
  tailoredOutput    Json?
  coverLetterOutput Json?
  guardReport       Json?
  createdAt         DateTime @default(now())

  @@index([aiRunId])
}

// ──────────────── Saved Searches & Job Alerts ────────────────

enum AlertFrequency {
  INSTANT
  DAILY
  WEEKLY
}

model SavedSearch {
  id              String         @id @default(uuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String         @db.VarChar(100)
  keywords        String[]
  locations       String[]
  jobTypes        String[]
  seniorities     String[]
  salaryMin       Int?
  salaryMax       Int?
  remoteOnly      Boolean        @default(false)
  visaSponsorship Boolean        @default(false)
  alertEnabled    Boolean        @default(true)
  alertFrequency  AlertFrequency @default(DAILY)
  lastAlertAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([alertEnabled, alertFrequency])
}

model JobAlert {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId        String
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  searchId     String?
  matchScore   Int?
  sentAt       DateTime?
  clickedAt    DateTime?
  createdAt    DateTime @default(now())

  @@unique([userId, jobId])
  @@index([userId, sentAt])
  @@index([jobId])
}

// ──────────────── Company Reviews & Ratings ────────────────

model CompanyReview {
  id                String   @id @default(uuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  overallRating     Int      // 1-5
  cultureRating     Int?     // 1-5
  salaryRating      Int?     // 1-5
  workLifeRating    Int?     // 1-5
  managementRating  Int?     // 1-5
  growthRating      Int?     // 1-5
  title             String   @db.VarChar(200)
  pros              String   @db.Text
  cons              String   @db.Text
  advice            String?  @db.Text
  isCurrentEmployee Boolean  @default(false)
  employmentStatus  String?  @db.VarChar(50) // full-time, contract, intern
  jobTitle          String?  @db.VarChar(100)
  yearsAtCompany    Int?
  isVerified        Boolean  @default(false)
  isApproved        Boolean  @default(false)
  helpfulCount      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([companyId, isApproved])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

model CompanyRatingAggregate {
  id                    String   @id @default(uuid())
  companyId             String   @unique
  company               Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  totalReviews          Int      @default(0)
  averageOverall        Float?
  averageCulture        Float?
  averageSalary         Float?
  averageWorkLife       Float?
  averageManagement     Float?
  averageGrowth         Float?
  recommendationPct     Float?   // % who would recommend
  updatedAt             DateTime @updatedAt
}

// ──────────────── Skills Assessment Integration ────────────────

enum AssessmentProvider {
  INTERNAL
  TESTGORILLA
  HACKERRANK
  CODILITY
  CUSTOM
}

enum AssessmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  EXPIRED
  FAILED
}

model SkillAssessment {
  id              String             @id @default(uuid())
  userId          String
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  skillName       String             @db.VarChar(100)
  provider        AssessmentProvider
  externalId      String?            @db.VarChar(255)
  status          AssessmentStatus   @default(PENDING)
  score           Int?               // 0-100
  percentile      Int?               // 0-100
  level           String?            @db.VarChar(50) // beginner, intermediate, advanced, expert
  resultUrl       String?            @db.VarChar(500)
  metadata        Json?
  completedAt     DateTime?
  expiresAt       DateTime?
  createdAt       DateTime           @default(now())

  @@index([userId, skillName])
  @@index([status])
}

model AssessmentInvite {
  id            String             @id @default(uuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId         String?
  job           Job?               @relation(fields: [jobId], references: [id], onDelete: SetNull)
  applicationId String?
  provider      AssessmentProvider
  assessmentUrl String             @db.VarChar(500)
  expiresAt     DateTime
  completedAt   DateTime?
  createdAt     DateTime           @default(now())

  @@index([userId])
  @@index([jobId])
}
